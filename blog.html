<!DOCTYPE html>
<html ng-app="sampleApp">
<head lang="en">
	<meta charset="UTF-8">
	<title>Blog Example</title>

	<script src="https://code.jquery.com/jquery-2.1.3.min.js"></script>

	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.14/angular.min.js"></script>
	<script src='https://cdn.firebase.com/js/client/2.2.1/firebase.js'></script>
	<script src="https://cdn.firebase.com/libs/angularfire/1.0.0/angularfire.min.js"></script>

	<script src="js/test-angularFire.js"></script>
</head>
<body ng-controller="SampleCtrl">
	<script>
		var postsRef = new Firebase("https://jo-example-blog.firebaseio.com/posts");
		var usersRef = new Firebase("https://jo-example-blog.firebaseio.com/users");

		$(document).ready(function() {
			$('#setUsers').on('click',setUsers);
			$('#setPosts').on('click',setPosts);
			$('#setNickname').on('click',function() {
				var userId = $('#username').val();
				var nickname = $('#nickname').val();
				if (userId && nickname) {
					addNickname(userId,nickname);
				} else {
					alert('You must select a user and provide a nickname');
				}
			});
			$('#clearNickname').on('click',function() {
				var userId = $('#username').val();
				if (userId) {
					clearNickname(userId);
				} else {
					alert('You must select a user');
				}

			});


			var controlSet = $('.controls');
			var output = $('.output');

			/*function getUsers() {
				return ref.child("users");
			}*/

			// Attach an asynchronous callback to read the data at our posts reference
			postsRef.on("value", function(snapshot) {
				console.log(snapshot.val());
			}, function (errorObject) {
				console.log("The read failed: " + errorObject.code);
			});

			function setUsers() {
				console.log('firing setUsers');
				usersRef.set({
					alanisawesome: {
						date_of_birth: "June 23, 1912",
						full_name: "Alan Turing"
					},
					gracehop: {
						date_of_birth: "December 9, 1906",
						full_name: "Grace Hopper"
					}
				});

				usersRef.child('benIsaac').set({
					date_of_birth: 'February 27, 2015'
					,full_name: "Benjamin Isaac Orvis"
				});

				writeOutput('Users have been added');
			}

			function setPosts() {
				postsRef.push({
					author: "gracehop",
					title: "Announcing COBOL, a New Programming Language"
				});
				postsRef.push({
					author: "alanisawesome",
					title: "The Turing Machine"
				});

				// Generate a reference to a new location and add some data using push()
				var newPostRef = postsRef.push({
					author: "benIsaac",
					title: "I am the cutest baby ever"
				});

				// Get the unique ID generated by push()
				var postID = newPostRef.key();

				console.log('Bens post is ID ',postID);
			}

			function addNickname(userId,nickname) {
				var user = usersRef.child(userId);
				user.update({
					"nickname": nickname
				},function(error) {
					genericCallback('Added nickname "' + nickname + '" for user ' + userId,error)
				});

				writeOutput();
			}

			function clearNickname(userId) {
				var user = usersRefchild(userId);
				user.update({
					"nickname": null
				},function(error) {
					genericCallback('Removed nickname for user ' + userId,error)
				});

			}

			function genericCallback(successMsg,error) {
				if (error) {
					alert('problem saving data');
					console.log(error);
				} else {
					writeOutput(successMsg);
				}
			}

			function writeOutput(msg) {
				output.append('<div>' + msg + '</div>');
			}
		});
	</script>

	<div class="controls">
		<div>
			<button id="setUsers">Set Users</button>
			<button id="setPosts">Set Posts</button>
		</div>
		<div>
			<select id="username" ng-model="selectedUser">
				<option>-- Select a user --</option>
				<option ng-repeat="(user,userData) in data.users track by user">{{userData.full_name}} | {{user}}</option>
			</select>
			<input type="text" id="nickname" placeholder="Nickname">
			<button id="setNickname">Set Nickname</button>
			<button id="clearNickname">Clear Nickname</button>
		</div>
	</div>
	<div class="output">

	</div>
	<div class="angularOutput">
<pre>
{{data.users | jsonFull}}
</pre>
		<ul>
			<li ng-repeat="user in data.users">{{user.full_name}}, born {{user.date_of_birth}}</li>
		</ul>

		<ul>
			<li ng-repeat="post in data.posts">
				<div class="title">{{post.title}}</div>
				<div class="author">By {{post.author}}</div>
			</li>
		</ul>
	</div>
</body>
</html>